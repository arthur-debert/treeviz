{#- Main tree rendering template -#}
{% macro render_node(node, depth=0, symbols=None, terminal_width=80, use_color=True) -%}
{%- set indent = "  " * depth -%}
{%- set icon = node.icon or (symbols[node.type] if node.type and symbols else "?") -%}
{%- set label = node.label | trim -%}
{%- set extras = node.extra | format_extras -%}
{%- set line_count = (node.children | length) if node.children else node.content_lines -%}
{%- set count_str = line_count ~ "L" -%}

{#- Use the layout calculator to get properly formatted line with positions -#}
{%- if use_color -%}
{%- set layout_result = calculate_line_layout_with_positions(indent, icon, label, extras, count_str, terminal_width) -%}
{%- set line_parts = layout_result[0] -%}
{%- set positions = layout_result[1] -%}
{{ apply_rich_markup_with_positions(line_parts, positions) }}
{% else -%}
{%- set line_parts = calculate_line_layout(indent, icon, label, extras, count_str, terminal_width) -%}
{{ line_parts }}
{% endif -%}
{%- for child in node.children %}
{{ render_node(child, depth + 1, symbols, terminal_width, use_color) }}
{%- endfor -%}
{%- endmacro %}

{#- Entry point: render the root node -#}
{{ render_node(root_node, 0, symbols, terminal_width, use_color) -}}