{#- Main tree rendering template -#}
{% macro render_node(node, depth=0, render_options=None, terminal_width=80, use_color=True) -%}
{%- set indent = "  " * depth -%}
{%- set icon = node.icon or (render_options.symbols[node.type] if node.type and render_options else "?") -%}
{%- set label = node.label | trim -%}
{%- set extras = node.extra | format_extras -%}
{%- set line_count = (node.children | length) if node.children else node.content_lines -%}
{%- set count_str = line_count ~ "L" -%}

{#- Use the layout calculator to get properly formatted line -#}
{%- set line_parts = calculate_line_layout(indent, icon, label, extras, count_str, terminal_width) -%}

{#- Apply Rich markup if color is enabled -#}
{%- if use_color -%}
{{ apply_rich_markup(line_parts, indent, icon, label, extras, count_str) }}
{% else -%}
{{ line_parts }}
{% endif -%}
{%- for child in node.children %}
{{ render_node(child, depth + 1, render_options, terminal_width, use_color) }}
{%- endfor -%}
{%- endmacro %}

{#- Entry point: render the root node -#}
{{ render_node(root_node, 0, render_options, terminal_width, use_color) -}}